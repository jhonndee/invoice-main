{% extends 'base.html' %}
{% block content %}

<div class="space-y-6 p-6 text-gray-900 dark:text-gray-100">

    <!-- Header + Actions -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <h1 class="text-2xl font-semibold">Factures</h1>

        <div class="flex gap-2">
            <a href="{% url 'invoice_create' %}"
               class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
               + Créer une facture
            </a>
            <a href="{% url 'dashboard' %}"
               class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-lg hover:opacity-90 transition">
               Dashboard
            </a>
        </div>
    </div>

    <!-- Barre de recherche -->
    <div class="mb-4">
        <input type="text" id="invoiceSearch" placeholder="Rechercher par ID, client, statut ou total"
               class="w-full border rounded-lg px-4 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100
                      focus:outline-none focus:ring-2 focus:ring-blue-500"
               onkeyup="filterInvoices()">
    </div>

    <!-- Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden">
        <table id="invoicesTable" class="w-full text-sm">
            <thead class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200">
                <tr>
                    <th class="px-4 py-3 text-left">ID</th>
                    <th class="px-4 py-3 text-left">Client</th>
                    <th class="px-4 py-3 text-left">Statut</th>
                    <th class="px-4 py-3 text-left">Total</th>
                    <th class="px-4 py-3 text-left">Actions</th>
                </tr>
            </thead>

            <tbody id="invoicesTbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for invoice in invoices %}
                <tr>
                    <td class="px-4 py-3">{{ invoice.id }}</td>
                    <td class="px-4 py-3">{{ invoice.client.name }}</td>
                    <td class="px-4 py-3">{{ invoice.status }}</td>
                    <td class="px-4 py-3">{{ invoice.total }}</td>
                    <td class="px-4 py-3 space-x-2">
                        <a href="{% url 'invoice_edit' invoice.pk %}" class="text-blue-600 dark:text-blue-400 hover:underline">Éditer</a>
                        <a href="{% url 'invoice_delete' invoice.pk %}" class="text-red-600 dark:text-red-400 hover:underline">Supprimer</a>
                        <a href="{% url 'invoice_detail' invoice.pk %}" class="text-green-600 dark:text-green-400 hover:underline">PDF</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="px-4 py-6 text-center text-gray-500 dark:text-gray-400">
                        Aucune facture enregistrée
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-center mt-4 space-x-2" id="pagination"></div>

</div>

<!-- JS Recherche + Pagination -->
<script>
const rowsPerPage = 20;
let currentPage = 1;

const tbody = document.getElementById("invoicesTbody");
const rows = Array.from(tbody.querySelectorAll("tr")).filter(r => !r.classList.contains("empty-row"));

// --- Fonction de filtrage ---
function filterInvoices() {
    const filter = document.getElementById("invoiceSearch").value.toLowerCase();
    rows.forEach(row => {
        const id = row.cells[0].textContent.toLowerCase();
        const client = row.cells[1].textContent.toLowerCase();
        const status = row.cells[2].textContent.toLowerCase();
        const total = row.cells[3].textContent.toLowerCase();
        row.style.display = (id.includes(filter) || client.includes(filter) || status.includes(filter) || total.includes(filter)) ? "" : "none";
    });
    currentPage = 1;
    paginate();
}

// --- Pagination ---
function paginate() {
    const filteredRows = rows.filter(r => r.style.display !== "none");
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    filteredRows.forEach((row, index) => {
        row.style.display = (index >= start && index < end) ? "" : "none";
    });

    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";
    for(let i=1; i<=totalPages; i++){
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = `px-3 py-1 rounded ${i===currentPage?'bg-blue-600 text-white':'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100'}`;
        btn.addEventListener("click", () => { currentPage=i; paginate(); });
        pagination.appendChild(btn);
    }
}

// Initialisation
paginate();
</script>

{% endblock %}
